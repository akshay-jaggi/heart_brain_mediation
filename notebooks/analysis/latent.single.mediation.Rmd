---
title: "R Notebook"
output: html_notebook
---

# Set Up
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("../.."))
```

# Imports
```{r}
library(finalfit)
library(mice)
library(purrr)
library(dplyr)
library(lavaan)
library(ggplot2)
library(gplots)
source('functions/mediation.R')
```

# Load Data
```{r}
latents.covariates.scaled = 
  read.csv('data_derived/merged/latents.covariates.scaled.csv')
latents.covariates.residualized.scaled = read.csv('data_derived/merged/latents.covariates.residualized.scaled.csv')
all.features = read.csv('data_derived/merged/vrf.cog.heart.brain.trad.healthy.csv')
```

```{r}
latents.covariates.scaled$cov_LVV = all.features$cardio_bmi
latents.covariates.residualized.scaled$cov_LVV = all.features$cardio_bmi
```


# Simple Mediation Model for each Mediator 
```{r}
independent.variable = 'cardio_latent_gvrf'
dependent.variable   = 'cog_latent_g'
mediators = colnames(latents.covariates.scaled)[grepl('latent',colnames(latents.covariates.scaled)) &
                                                grepl('heart|brain',colnames(latents.covariates.scaled))]
covariates = c('cov_age', 'cov_sex','cov_LVV')
```

```{r}
mediation.latent.single = run.single.mediation(latents.covariates.scaled, 
                                              independent.variable,
                                              dependent.variable, 
                                              mediators, covariates)
mediation.latent.single.final = process.mediation.results(mediation.latent.single)
```

```{r}
write.csv(mediation.latent.single.final,
          "tables/final/mediation.latent.single.csv")
```


# Simple Mediation Model for each Mediator Residualized

```{r}
mediation.latent.single.resid = run.single.mediation(latents.covariates.residualized.scaled, 
                                              independent.variable,
                                              dependent.variable, 
                                              mediators, covariates)
mediation.latent.single.resid.final = process.mediation.results(mediation.latent.single.resid)
```

```{r}
write.csv(mediation.latent.single.resid.final,
          "tables/final/mediation.latent.single.residualized.csv")
```

# Eleanors Plots
```{r}
source('functions/Figure3_revision.R')
```

```{r}
x
ggsave('figures/analysis/mediation.latent.single.png')
```
```{r}
cor(latents.covariates.residualized.scaled[,grep('cc2|bsa',colnames(latents.covariates.scaled))],
    all.features[,grep('cmr|bsa',colnames(all.features))])
```

