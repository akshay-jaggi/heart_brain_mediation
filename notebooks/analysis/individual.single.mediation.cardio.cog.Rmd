---
title: "R Notebook"
output: html_notebook
---

# Set Up
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("../.."))
```

# Imports
```{r}
library(finalfit)
library(mice)
library(purrr)
library(dplyr)
library(lavaan)
library(ggplot2)
library(gplots)
source('functions/mediation.R')
source('functions/Figure7.R')
```

# Load Data
```{r}
latents.covariates.scaled = 
  read.csv('data_derived/merged/latents.covariates.scaled.csv')
latents.covariates.residualized.scaled = read.csv('data_derived/merged/latents.covariates.residualized.scaled.csv')
all.features = 
  read.csv('data_derived/merged/vrf.cog.heart.brain.trad.healthy.csv')
```

# Scale Cardio and Cog Features
```{r}
cardio.cog = all.features[,grepl('cardio_|cog_',colnames(all.features)) & 
                            !grepl('prosmem',colnames(all.features))]
is.nonbinary = sapply(cardio.cog, function(x) !all(x %in% 0:1))
cardio.cog.scaled = cardio.cog
cardio.cog.scaled$cog_vismem = -cardio.cog.scaled$cog_vismem
cardio.cog.scaled$cog_rt = -cardio.cog.scaled$cog_rt
cardio.cog.scaled[,is.nonbinary] = scale(cardio.cog.scaled[,is.nonbinary])
```

```{r}
latents.covariates.cardio.cog = cbind(latents.covariates.scaled, cardio.cog.scaled)
latents.covariates.cardio.cog.resid = cbind(latents.covariates.residualized.scaled, cardio.cog.scaled)
```

# Individual Feature Mediation 

```{r}
cardio.features = colnames(cardio.cog)[grepl('cardio_',colnames(cardio.cog))]
cog.features = colnames(cardio.cog)[grepl('cog_',colnames(cardio.cog))]
mediators = colnames(latents.covariates.scaled)[grepl('latent',colnames(latents.covariates.scaled)) &
                                                grepl('heart|brain',colnames(latents.covariates.scaled))]
covariates = c('cov_age', 'cov_sex')
```

```{r}
mediation.individual.pairs = mediation.ind.dep.pairs(latents.covariates.cardio.cog, 
                                                     cardio.features, cog.features, mediators, covariates)
```

```{r}
write.csv(mediation.individual.pairs,
          "tables/final/mediation.individual.pairs.csv")
```

# Individual Feature Mediation Residualized

```{r}
mediation.individual.pairs.resid = mediation.ind.dep.pairs(latents.covariates.cardio.cog.resid, 
                                                     cardio.features, cog.features, mediators, covariates)
```

```{r}
write.csv(mediation.individual.pairs.resid,
          "tables/final/mediation.individual.pairs.resid.csv")
```


```{r}
for (ind.dep in unique(paste(mediation.individual.pairs.resid$independent, mediation.individual.pairs.resid$dependent))) {
  ind.dep = strsplit(ind.dep,' ')[[1]]
  independent = ind.dep[1]
  dependent = ind.dep[2]
  to.plot = mediation.individual.pairs.resid[mediation.individual.pairs.resid$independent==independent &
                                                           mediation.individual.pairs.resid$dependent==dependent,]
  sorting = sort.by.ies(to.plot)
  plot.obj = direct.indirect.plot(to.plot,sorting, ylims=c(-0.1,0.1))
  print(plot.obj)
  ggsave(paste(c('figures/analysis/mediation.latent',independent,dependent,'png'),collapse='.'))
}
```






