---
title: "R Notebook"
output: html_notebook
---

# Set Up
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("../.."))
```

# Imports
```{r}
library(finalfit)
library(mice)
library(purrr)
library(dplyr)
```

# Load Data
```{r}
heart.radiomics = read.csv("data/heart.radiomics.csv")
heart.traditional = read.csv("data/cardio.data.csv")
heart.bai = read.csv('data/heart.measures.bai.csv')
```

# Prep Radiomics Data
```{r}
heart.radiomics.notdeprecated = heart.radiomics[,heart.radiomics[1,]!="Deprecated"]
```

```{r}
feature.groups = read.csv("data/radiomics.groups.csv")
```

```{r}
new_cols = paste(feature.groups[,2],
             colnames(heart.radiomics.notdeprecated)[2:ncol(heart.radiomics.notdeprecated)],
             sep = "_")
colnames(heart.radiomics.notdeprecated)[2:ncol(heart.radiomics.notdeprecated)] = new_cols
```

```{r}
feature.groups$Feature = colnames(heart.radiomics.notdeprecated)[2:ncol(heart.radiomics.notdeprecated)]
heart.groups = feature.groups[grep("MYO|shape",feature.groups$Feature),2]
```


```{r}
heart.radiomics.touse = heart.radiomics.notdeprecated[,
                                                      grep("f.eid|MYO|shape",
                                                  colnames(heart.radiomics.notdeprecated))]
```

# Prep Traditional Metrics
```{r}
heart.traditional = heart.traditional[,grepl('cmr_|f.eid',colnames(heart.traditional))]
```

# Prep Bai
```{r}
colnames(heart.bai) = lapply(colnames(heart.bai),function(x) paste('cmr',strsplit(x,'..',fixed=TRUE)[[1]][1],sep='_'))
colnames(heart.bai)[1] = 'f.eid'
```

# Match IDs
```{r}
heart.bai.complete = heart.bai[complete.cases(heart.bai),]
heart.traditional.complete = heart.traditional[complete.cases(heart.traditional),]
```

```{r}
dups = duplicated(heart.traditional.complete[,2:ncol(heart.traditional.complete)])
heart.traditional.unique = heart.traditional.complete[!dups,]
```

```{r}
test = heart.bai.complete[,colnames(heart.bai.complete) %in% colnames(heart.traditional.unique)]
nvars = ncol(heart.traditional.unique)
```


```{r}
for(i in 1:nrow(test)) {
  query = test[i,2:nvars]
  for(j in 1:nrow(heart.traditional.unique)) {
    source = heart.traditional.unique[j,2:nvars]
    equality = sum(abs(query - source)) < 0.1
    if (equality) {
      print(query)
      print(source)
      break
    }
  }
  break
}
```


```{r}
test = merge(heart.bai, heart.traditional,by='LVEDV_trunc')
```


# Merge
```{r}

heart.radiomics.final = heart.radiomics.touse[complete.cases(heart.radiomics.touse),]
heart.imaging.final = merge(heart.bai.final, heart.radiomics.final,by='f.eid')
heart.imaging.final = heart.imaging.final %>% dplyr::select(f.eid, everything())
```

```{r}
feids.shared = intersect(heart.radiomics.final$f.eid, heart.bai.final$f.eid)
write.csv(feids.shared,'data/heart.feids.shared.csv')
```


# Save
```{r}
write.csv(heart.imaging.final,'data_derived/cleaned/heart_cleaned.csv', row.names = FALSE)
```
