---
title: "R Notebook"
output: html_notebook
---

# Set Up
```{r setup}
knitr::opts_knit$set(root.dir = normalizePath("../.."))
```

# Imports
```{r}
library(candisc)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
source('functions/explained_variance.R')
source('functions/heatmaps.custom.R')
```

# Load Data
```{r}
merged.data.complete.new = read.csv('data_derived/merged/vrf.cog.heart.brain.new.healthy.csv')
```

```{r}
merged.heart = merged.data.complete.new[,grepl("heart_",colnames(merged.data.complete.new))]
merged.brain = merged.data.complete.new[,grepl("brain_",colnames(merged.data.complete.new))]
```

```{r}
merged.heart.zscore = data.frame(scale(merged.heart))
merged.brain.zscore = data.frame(scale(merged.brain))
```

```{r}
write.csv(merged.brain.zscore,'data_derived/dim_red/brain.csv',row.names = FALSE)
write.csv(merged.heart.zscore,'data_derived/dim_red/heart.csv',row.names = FALSE)
```


# CCA Performed in Sklearn
```{r}
brain.ccs = read.csv('data_derived/dim_red/brain_ccs.csv',row.names = 1)
heart.ccs = read.csv('data_derived/dim_red/heart_ccs.csv',row.names = 1)
```

```{r}
cancors = diag(cor(heart.ccs, brain.ccs))
```

```{r}
ggplot() + 
  geom_line(aes(x=seq(1,10),y=cancors)) + 
  theme_classic() + labs(y='Canonical Correlation', x='Covariate Number') + 
  scale_x_continuous(breaks=seq(1,10,1))
ggsave('figures/dim_red/cca.cors.png')
```


```{r}
heart.scores = data.frame(cor(merged.heart.zscore, heart.ccs))
brain.scores = data.frame(cor(merged.brain.zscore, brain.ccs))
```

```{r}
write.csv(heart.scores,'tables/dim_red/heart.cca.scores.csv')
write.csv(brain.scores,'tables/dim_red/brain.cca.scores.csv')
```

```{r}
brain.ccs$f.eid = merged.data.complete.new$f.eid
heart.ccs$f.eid = merged.data.complete.new$f.eid
brain.ccs = brain.ccs %>% select(f.eid, everything())
heart.ccs = heart.ccs %>% select(f.eid, everything())
```

```{r}
colnames(heart.ccs) = c('f.eid',paste('heart_latent_cc',seq(1,10),sep=''))
colnames(brain.ccs) = c('f.eid',paste('brain_latent_cc',seq(1,10),sep=''))
```


```{r}
write.csv(brain.ccs,'data_derived/dim_red/latents_brain_ccs.csv',row.names = FALSE)
write.csv(heart.ccs,'data_derived/dim_red/latents_heart_ccs.csv',row.names = FALSE)
```

# Heatmap

```{r}
merged.heart.zscore = merged.heart.zscore[,order(colnames(merged.heart.zscore))]
merged.brain.zscore = merged.brain.zscore[,order(colnames(merged.brain.zscore))]

heart.brain.cor = cor(merged.heart.zscore, merged.brain.zscore)
heart.groups = sapply(colnames(merged.heart.zscore),function(x) strsplit(x,'_')[[1]][2])
heart.groups = factor(heart.groups, levels = c("shape","intensity","texture"))
group.numbers <- as.numeric(heart.groups)
side.colors <- brewer.pal(9, "Set1")[group.numbers]

brain.groups = sapply(colnames(merged.brain.zscore),function(x) strsplit(x,'_')[[1]][3])
brain.groups[grepl('volume',colnames(merged.brain.zscore))] = 'volume'
brain.groups = factor(brain.groups)
group.numbers <- as.numeric(brain.groups)
bottom.colors <- brewer.pal(10, "Set3")[group.numbers]
```

```{r}
heart.scores = heart.scores[order(rownames(heart.scores)),]
brain.scores = brain.scores[order(rownames(brain.scores)),]

data = heart.brain.cor[order(heart.scores$X0),order(brain.scores$X0)]
test.names1 = heart.groups[order(heart.scores$X0)]
test.names2 = brain.groups[order(brain.scores$X0)]
test.palette1 = side.colors[order(heart.scores$X0)]
test.palette2 = bottom.colors[order(brain.scores$X0)]
#png(file = 'figures/dim_red/heart.brain.cor.png',width=1200,height=800)
heatmap.with.twobars(data, test.names1, test.names2, test.palette1, test.palette2)
#dev.off()
```


```{r}
#png(file = 'figures/dim_red/heart.cor.png',width=1200,height=800)
heatmap.with.twobars(heart.brain.cor, #[order(heart.scores$X0), order(brain.scores$X0)],
                     heart.groups,#[order(heart.scores$X0)],
                     brain.groups,#[order(brain.scores$X0)],
                     side.colors, #[order(heart.scores$X0)], 
                     bottom.colors) #[order(brain.scores$X0)])
#dev.off()
```


# EVR

```{r}
evr_nonorth(merged.heart.zscore, heart.ccs[,2:ncol(heart.ccs)])
```

```{r}
evr_orth(merged.heart.zscore, heart.ccs[,2:ncol(heart.ccs)])
```

```{r}
evr_orth(merged.brain.zscore, brain.ccs[,2:ncol(brain.ccs)])
```